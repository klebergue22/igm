<ui:composition template="/templates/template.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

    <f:metadata>
        <f:viewAction action="#{empleadoController.preRenderView}" onPostback="false"/>
    </f:metadata>


    <ui:define name="title">Empleados</ui:define>

    <ui:define name="content">
        <!-- Mensajes GLOBALes -->
        <p:messages id="msgsEmpl" globalOnly="true" showIcon="true" closable="true"/>

        <!-- ===== Toolbar ===== -->
        <p:toolbar class="p-mb-2">
            <p:toolbarGroup>
               

                <!-- NUEVO -->
                <p:commandButton value="Nuevo" icon="pi pi-plus"
                                 action="#{empleadoController.nuevo}"
                                 process="@this"
                                 update=":layoutForm:dialogZone"
                                 resetValues="true"
                                 onstart="PF('statusDialog').show()"
                                 oncomplete="PF('statusDialog').hide(); PF('dlgEmp').show();"/>

               
            </p:toolbarGroup>

            <p:toolbarGroup align="right">
                <p:commandButton type="button" value="Limpiar filtros" icon="pi pi-filter-slash"
                                 onclick="PF('tblWV').clearFilters()" styleClass="p-button-text"/>
            </p:toolbarGroup>
        </p:toolbar>

        <!-- ===== Tabla ===== -->
        <p:dataTable id="tbl" value="#{empleadoController.lista}" var="e"
                     widgetVar="tblWV" paginator="true" rows="20"
                     rowsPerPageTemplate="10,20,50,100"
                     emptyMessage="Sin resultados" filterEvent="keyup" filterDelay="400">

            <p:column headerText="NoPersona" sortBy="#{e.noPersona}" filterBy="#{e.noPersona}" filterMatchMode="contains">
                <h:outputText value="#{e.noPersona}"/>
            </p:column>

            <p:column headerText="Cédula" sortBy="#{e.noCedula}" filterBy="#{e.noCedula}" filterMatchMode="contains">
                <h:outputText value="#{e.noCedula}"/>
            </p:column>

            <p:column headerText="Apellidos" sortBy="#{e.priApellido}" filterBy="#{e.priApellido} #{e.segApellido}" filterMatchMode="contains">
                <h:outputText value="#{e.priApellido} #{e.segApellido}"/>
            </p:column>

            <p:column headerText="Nombres" sortBy="#{e.nombres}" filterBy="#{e.nombres}" filterMatchMode="contains">
                <h:outputText value="#{e.nombres}"/>
            </p:column>

            <p:column headerText="Código Institucional" sortBy="#{e.codigo}" filterBy="#{e.codigo}" filterMatchMode="contains">
                <h:outputText value="#{e.codigo}"/>
            </p:column>

            <p:column headerText="Email" sortBy="#{e.email}" filterBy="#{e.email}" filterMatchMode="contains">
                <h:outputText value="#{e.email}"/>
            </p:column>

            <p:column headerText="Email Institucional" sortBy="#{e.emailInstitucional}" filterBy="#{e.emailInstitucional}" filterMatchMode="contains">
                <h:outputText value="#{e.emailInstitucional}"/>
            </p:column>

            <p:column headerText="Acciones" style="width:220px" exportable="false" filterable="false">
                <!-- EDITAR -->
                <p:commandButton value="Editar" icon="pi pi-pencil" styleClass="p-button-text"
                                 process="@this"
                                 update=":layoutForm:dialogZone"
                                 onstart="PF('statusDialog').show()"
                                 oncomplete="PF('statusDialog').hide(); PF('dlgEmp').show();">
                    <f:setPropertyActionListener target="#{empleadoController.seleccionado}" value="#{e}"/>
                </p:commandButton>

                <!-- ELIMINAR -->
                <p:commandButton value="Eliminar" icon="pi pi-trash" styleClass="p-button-text p-ml-2"
                                 process="@this"
                                 actionListener="#{empleadoController.eliminar(e.noPersona)}"
                                 update=":layoutForm:tbl :layoutForm:msgsEmpl"
                                 onclick="return confirm('¿Eliminar registro seleccionado?');"/>
            </p:column>
        </p:dataTable>

        <!-- ===== Diálogo (tiene su propio <h:form>) ===== -->
        <p:outputPanel id="dialogZone" layout="block">
            <p:dialog id="dlg" widgetVar="dlgEmp" header="Empleado"
                      modal="true" appendTo="@(body)" width="860" resizable="true"
                      dynamic="true" closeOnEscape="false" styleClass="dlgEmp-scroll">

                <!-- FORM DEL DIÁLOGO -->
                <h:form id="dlgForm">
                    <!-- Mensajes dentro del diálogo -->
                    <p:messages id="dlgMsgs" showIcon="true" showDetail="true" closable="true"/>

                    <!-- Grid de campos (mantén tu CSS emp-6col) -->
                    <p:panelGrid id="empForm" styleClass="emp-6col ui-fluid">

                        <!-- Fila 1 -->
                        <p:row>
                            <p:column styleClass="lab"><p:outputLabel for="cedula" value="Cédula *"/></p:column>
                            <p:column styleClass="fld">
                                <p:inputText id="cedula" value="#{empleadoController.seleccionado.noCedula}"
                                             maxlength="10" required="true" requiredMessage="La cédula es obligatoria">
                                    <p:keyFilter mask="num"/>
                                    <f:validateRegex pattern="\d{10}"/>
                                </p:inputText>
                            </p:column>
                            <p:column styleClass="msg"><p:message for="cedula" display="icon"/></p:column>

                            <p:column styleClass="lab"><p:outputLabel for="fNac" value="Fecha de Nacimiento *"/></p:column>
                            <p:column styleClass="fld">
                                <p:calendar id="fNac"
                                            value="#{empleadoController.seleccionado.FNacimiento}"
                                            pattern="dd/MM/yyyy"
                                            showOn="button"
                                            navigator="true"
                                            yearRange="1900:2100"
                                            maxdate="#{empleadoController.fechaMaxNacimiento}"
                                            validator="#{empleadoController.validarMayorDeEdad}"/>
                            </p:column>
                            <p:column styleClass="msg"><p:message for="fNac" display="icon"/></p:column>
                        </p:row>

                        <!-- Fila 2 -->
                        <p:row>
                            <p:column styleClass="lab"><p:outputLabel for="priApellido" value="Primer Apellido *"/></p:column>
                            <p:column styleClass="fld">
                                <p:inputText id="priApellido" value="#{empleadoController.seleccionado.priApellido}"
                                             maxlength="20" required="true"/>
                            </p:column>
                            <p:column styleClass="msg"><p:message for="priApellido" display="icon"/></p:column>

                            <p:column styleClass="lab"><p:outputLabel for="segApellido" value="Segundo Apellido *"/></p:column>
                            <p:column styleClass="fld">
                                <p:inputText id="segApellido" value="#{empleadoController.seleccionado.segApellido}"
                                             maxlength="20" required="true"/>
                            </p:column>
                            <p:column styleClass="msg"><p:message for="segApellido" display="icon"/></p:column>
                        </p:row>

                        <!-- Fila 3 -->
                        <p:row>
                            <p:column styleClass="lab"><p:outputLabel for="nombre" value="Nombres *"/></p:column>
                            <p:column styleClass="fld">
                                <p:inputText id="nombre" value="#{empleadoController.seleccionado.nombres}"
                                             maxlength="30" required="true"/>
                            </p:column>
                            <p:column styleClass="msg"><p:message for="nombre" display="icon"/></p:column>

                            <p:column styleClass="lab"><p:outputLabel for="codigo" value="Código Institucional"/></p:column>
                            <p:column styleClass="fld">
                                <p:inputText id="codigo" value="#{empleadoController.seleccionado.codigo}">
                                    <p:keyFilter mask="num"/>
                                    <!-- permite 1 a 10 dígitos; ajusta si debe ser exacto 10 -->
                                    <f:validateRegex pattern="\d{1,10}"/>
                                </p:inputText>
                            </p:column>
                            <p:column styleClass="msg"><p:message for="codigo" display="icon"/></p:column>
                        </p:row>

                        <!-- Fila 4 (ENUMS sin converters) -->
                        <p:row>
                            <p:column styleClass="lab"><p:outputLabel for="gSangre" value="Grupo sanguíneo *"/></p:column>
                            <p:column styleClass="fld">
                                <p:selectOneMenu id="gSangre"
                                                 value="#{empleadoController.seleccionado.grupoSangre}"
                                                 required="true" requiredMessage="Seleccione el grupo sanguíneo">
                                    <f:selectItem itemLabel="-- Seleccione --" itemValue="#{null}" noSelectionOption="true"/>
                                    <f:selectItems value="#{empleadoController.gruposSangre}" var="gs"
                                                   itemLabel="#{gs.descripcion}" itemValue="#{gs}"/>
                                </p:selectOneMenu>
                            </p:column>
                            <p:column styleClass="msg"><p:message for="gSangre" display="icon"/></p:column>

                            <p:column styleClass="lab"><p:outputLabel for="sexo" value="Sexo *"/></p:column>
                            <p:column styleClass="fld">
                                <p:selectOneMenu id="sexo"
                                                 value="#{empleadoController.seleccionado.sexo}"
                                                 required="true" requiredMessage="Seleccione el sexo">
                                    <f:selectItem itemLabel="-- Seleccione --" itemValue="#{null}" noSelectionOption="true"/>
                                    <f:selectItems value="#{empleadoController.sexos}" var="s"
                                                   itemLabel="#{s.descripcion}" itemValue="#{s}"/>
                                </p:selectOneMenu>
                            </p:column>
                            <p:column styleClass="msg"><p:message for="sexo" display="icon"/></p:column>
                        </p:row>

                        <!-- Fila 5 (ENUM) + Email -->
                        <p:row>
                            <p:column styleClass="lab"><p:outputLabel for="estCivil" value="Estado civil *"/></p:column>
                            <p:column styleClass="fld">
                                <p:selectOneMenu id="estCivil"
                                                 value="#{empleadoController.seleccionado.estCivil}"
                                                 required="true" requiredMessage="Seleccione el estado civil">
                                    <f:selectItem itemLabel="-- Seleccione --" itemValue="#{null}" noSelectionOption="true"/>
                                    <f:selectItems value="#{empleadoController.estadosCiviles}" var="ec"
                                                   itemLabel="#{ec.descripcion}" itemValue="#{ec}"/>
                                </p:selectOneMenu>
                            </p:column>
                            <p:column styleClass="msg"><p:message for="estCivil" display="icon"/></p:column>

                            <p:column styleClass="lab"><p:outputLabel for="email" value="Email"/></p:column>
                            <p:column styleClass="fld">
                                <p:inputText id="email" value="#{empleadoController.seleccionado.email}"/>
                            </p:column>
                            <p:column styleClass="msg"><p:message for="email" display="icon"/></p:column>
                        </p:row>

                        <!-- Fila 6 -->
                        <p:row>
                            <p:column styleClass="lab"><p:outputLabel for="emailInst" value="Email Institucional"/></p:column>
                            <p:column styleClass="fld">
                                <p:inputText id="emailInst" value="#{empleadoController.seleccionado.emailInstitucional}"/>
                            </p:column>
                            <p:column styleClass="msg"><p:message for="emailInst" display="icon"/></p:column>

                            <p:column styleClass="lab"></p:column>
                            <p:column styleClass="fld"></p:column>
                            <p:column styleClass="msg"></p:column>
                        </p:row>
                    </p:panelGrid>

                    <!-- Footer del diálogo -->
                    <f:facet name="footer">
                        <!-- DEBUG: sin validación -->
                        <p:commandButton value="Guardar (DEBUG)" icon="pi pi-bug"
                                         actionListener="#{empleadoController.debugLog}"
                                         process="@this"
                                         update=":layoutForm:msgsEmpl"
                                         immediate="true"/>

                    </f:facet>
                    <!-- Guardar REAL: valida todo el form del diálogo -->
                    <p:commandButton value="Guardar" icon="pi pi-check"
                                     action="#{empleadoController.guardar}"
                                     process="@form"
                                     update="@form :layoutForm:tbl :layoutForm:msgsEmpl"
                                     onstart="PF('statusDialog').show()"
                                     oncomplete="PF('statusDialog').hide(); 
                                     if (args &amp;&amp; args.validationFailed) { 
                                     PF('dlgEmp').show(); 
                                     } else { 
                                     PF('dlgEmp').hide(); 
                                     }"/>

                    <p:commandButton value="Cancelar" icon="pi pi-times" type="button"
                                     onclick="PF('dlgEmp').hide()" styleClass="p-button-secondary p-ml-2"/>
                </h:form>
            </p:dialog>
        </p:outputPanel>
    </ui:define>
</ui:composition>
