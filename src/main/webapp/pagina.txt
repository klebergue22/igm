<ui:composition template="/templates/template.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

    <ui:define name="title">Contrataciones</ui:define>

    <!-- Usa SOLO el <h:form id="layoutForm"> del template -->

    <ui:define name="content">

        <!-- ============================================ -->
        <!-- PANEL DE DEBUG (Eliminar después de pruebas) -->
        <!-- ============================================ -->
        <p:panel header="🔍 DEBUG - Eliminar después de las pruebas"
                 style="background:#ffffcc;margin-bottom:20px"
                 toggleable="true">
            <h:panelGrid columns="2" styleClass="ui-fluid">
                <h:outputLabel value="Controller existe:" style="font-weight:bold;"/>
                <h:outputText value="#{contratacionController != null ? 'SI' : 'NO'}"
                              style="color:blue;font-weight:bold;"/>

                <h:outputLabel value="FiltroNoPersona:" style="font-weight:bold;"/>
                <h:outputText value="#{contratacionController.filtroNoPersona != null ? contratacionController.filtroNoPersona : '(vacío)'}"
                              style="color:blue;font-weight:bold;"/>

                <h:outputLabel value="Lista:" style="font-weight:bold;"/>
                <h:outputText value="#{contratacionController.lista != null ? contratacionController.lista.size() : 0} registros"
                              style="color:green;font-weight:bold;"/>
            </h:panelGrid>

            <p:separator/>

            <h4>Botones de prueba:</h4>

            <!-- JSF -->
            <h:commandButton value="TEST: JSF Ping"
                             action="#{contratacionController.ping}"
                             styleClass="ui-button ui-widget ui-button-success"
                             style="margin:5px">
                <f:ajax execute="@form" render=":layoutForm:msgsPage"/>
            </h:commandButton>

            <!-- PrimeFaces -->
            <p:commandButton value="TEST: PF Ping"
                             actionListener="#{contratacionController.ping}"
                             update=":layoutForm:msgsPage"
                             styleClass="ui-button-warning"
                             style="margin:5px"/>

            <p:commandButton value="TEST: PF Buscar (sin filtro)"
                             actionListener="#{contratacionController.buscar}"
                             update=":layoutForm:msgsPage :layoutForm:tbl"
                             styleClass="ui-button-info"
                             style="margin:5px"
                             onclick="console.log('Click en TEST Buscar');"/>
        </p:panel>

        <!-- ============================================ -->
        <!-- MENSAJES (renombrado a msgsPage)            -->
        <!-- ============================================ -->
        <p:messages id="msgsPage" closable="true" showIcon="true"/>

        <!-- ============================================ -->
        <!-- FILTRO Y BÚSQUEDA                            -->
        <!-- ============================================ -->
        <p:toolbar class="p-mb-2 p-pt-0">
            <p:toolbarGroup>
                <p:inputNumber id="filtroNoPersona"
                               value="#{contratacionController.filtroNoPersona}"
                               decimalPlaces="0"
                               thousandSeparator=""
                               minValue="1"
                               placeholder="No Persona"
                               style="width:180px"
                               onchange="console.log('InputNumber changed to:', this.value);"/>

                <!-- Botón Buscar ORIGINAL con debug -->
                <p:commandButton value="Buscar"
                                 icon="pi pi-search"
                                 actionListener="#{contratacionController.buscar}"
                                 process="@this filtroNoPersona"
                                 update=":layoutForm:msgsPage :layoutForm:tbl"
                                 style="margin-left:5px"
                                 onclick="console.log('Click en Buscar ORIGINAL'); console.log('Filtro value:', document.getElementById('layoutForm:filtroNoPersona_input')?.value); return true;"/>

                <!-- Botón alternativo SIN process -->
                <p:commandButton value="Buscar (v2)"
                                 icon="pi pi-search"
                                 actionListener="#{contratacionController.buscar}"
                                 update=":layoutForm:msgsPage :layoutForm:tbl"
                                 style="margin-left:5px;background:orange"
                                 onclick="console.log('Click en Buscar V2');"/>

                <!-- Botón JSF puro -->
                <h:commandButton value="Buscar (JSF)"
                                 action="#{contratacionController.buscar}"
                                 styleClass="ui-button ui-widget"
                                 style="margin-left:5px;background:purple;color:white;border:none;padding:8px 16px;">
                    <f:ajax execute="@form" render=":layoutForm:msgsPage :layoutForm:tbl"/>
                </h:commandButton>
            </p:toolbarGroup>

            <p:toolbarGroup align="right">
                <p:commandButton value="Nuevo"
                                 icon="pi pi-plus"
                                 actionListener="#{contratacionController.nuevoDesdeBoton}"
                                 process="@this filtroNoPersona"
                                 update=":layoutForm:dlg"
                                 oncomplete="if (!args.validationFailed) PF('dlgCont').show()"/>
            </p:toolbarGroup>
        </p:toolbar>

        <!-- ============================================ -->
        <!-- TABLA DE RESULTADOS                          -->
        <!-- ============================================ -->
        <p:dataTable id="tbl"
                     value="#{contratacionController.lista}"
                     var="c"
                     widgetVar="tblContWV"
                     paginator="true"
                     rows="20"
                     rowsPerPageTemplate="10,20,50,100"
                     emptyMessage="Sin resultados - Haga clic en Buscar"
                     filterEvent="keyup"
                     filterDelay="400">

            <p:column headerText="NoPersona"
                      sortBy="#{c.noPersona}"
                      filterBy="#{c.noPersona}"
                      filterMatchMode="contains">
                <h:outputText value="#{c.noPersona}"/>
            </p:column>

            <p:column headerText="No Cont"
                      sortBy="#{c.noCont}"
                      filterBy="#{c.noCont}"
                      filterMatchMode="contains">
                <h:outputText value="#{c.noCont}"/>
            </p:column>

            <!-- ESTADO -->
            <p:column headerText="Estado" sortBy="#{c.estado}">
                <h:outputText value="#{c.estado != null ? c.estado.descripcion : '(sin estado)'}"/>
            </p:column>

            <!-- F. CONTRATO -->
            <p:column headerText="F. Contrato" sortBy="#{c.feContrato}">
                <h:outputText rendered="#{not empty c.feContrato}" value="#{c.feContrato}">
                    <f:convertDateTime pattern="dd/MM/yyyy" timeZone="America/Guayaquil"/>
                </h:outputText>
                <h:outputText rendered="#{empty c.feContrato}" value=""/>
            </p:column>

            <!-- F. SALIDA -->
            <p:column headerText="F. Salida" sortBy="#{c.feSalida}">
                <h:outputText rendered="#{not empty c.feSalida}" value="#{c.feSalida}">
                    <f:convertDateTime pattern="dd/MM/yyyy" timeZone="America/Guayaquil"/>
                </h:outputText>
                <h:outputText rendered="#{empty c.feSalida}" value=""/>
            </p:column>


            <p:column headerText="Acciones"
                      style="width:180px"
                      exportable="false"
                      filterable="false">

                <p:commandButton value="Editar"
                                 icon="pi pi-pencil"
                                 styleClass="p-button-text"
                                 process="@this"
                                 actionListener="#{contratacionController.editar(c)}"
                                 update=":layoutForm:dlg :layoutForm:msgsPage"  
                                 oncomplete="PF('dlgCont').show()" />
            </p:column>
        </p:dataTable>

        <!-- ============================================ -->
        <!-- DIÁLOGO PRINCIPAL (appendTo=body -> propio form) -->
        <!-- ============================================ -->
        <!-- ============================================ -->
        <!-- DIÁLOGO PRINCIPAL (appendTo=body -> propio form) -->
        <!-- ============================================ -->
        <p:dialog id="dlg" 
                  widgetVar="dlgCont" 
                  header="Contratación"
                  modal="true" 
                  appendTo="@(body)" 
                  width="900" 
                  resizable="true"
                  closeOnEscape="false">



            <!-- Mensajes -->
            <p:messages id="dlgMsgs" showIcon="true" closable="true"/>
            <h:panelGroup id="dlgForm">
                <!-- Panel con rendered -->
                <p:outputPanel id="dlgBody"
                               rendered="#{contratacionController.seleccionado ne null}">

                    <!-- TABLA HTML PURA (sin bordes, estilo militar) -->
                    <table class="emp-3col-table" style="width:100%;">
                        <tbody>

                            <!-- FILA 1: Estado -->
                            <tr>
                                <td class="lab">
                                    <p:outputLabel for="estado" value="Estado *"/>
                                </td>
                                <td class="fld">
                                    <p:selectOneMenu id="estado"
                                                     value="#{contratacionController.seleccionado.estado}"

                                                     required="true" 
                                                     requiredMessage="Estado es obligatorio"
                                                     style="width:100%">
                                        <f:selectItems value="#{contratacionController.estadosEnum}" 
                                                       var="e"
                                                       itemLabel="#{e.descripcion}" 
                                                       itemValue="#{e}"/>
                                    </p:selectOneMenu>
                                </td>
                                <td class="msg">
                                    <p:message for="estado"/>
                                </td>
                            </tr>

                            <!-- FILA 2: Tipo Contrato -->
                            <tr>
                                <td class="lab">
                                    <p:outputLabel for="ceContrato" value="Tipo Contrato *"/>
                                </td>
                                <td class="fld">
                                    <p:selectOneMenu id="ceContrato"
                                                     value="#{contratacionController.seleccionado.ceContrato}"

                                                     required="true" 
                                                     requiredMessage="Tipo Contrato es obligatorio"
                                                     style="width:100%">
                                        <f:selectItems value="#{contratacionController.tiposContratoEnum}" 
                                                       var="t"
                                                       itemLabel="#{t.descripcion}" 
                                                       itemValue="#{t}"/>
                                    </p:selectOneMenu>
                                </td>
                                <td class="msg">
                                    <p:message for="ceContrato"/>
                                </td>
                            </tr>

                            <!-- FILA 3: No Persona -->
                            <tr>
                                <td class="lab">
                                    <p:outputLabel for="noPersona" value="No Persona *"/>
                                </td>
                                <td class="fld">
                                    <p:inputNumber id="noPersona"
                                                   value="#{contratacionController.seleccionado.noPersona}"
                                                   decimalPlaces="0" 
                                                   thousandSeparator=""
                                                   required="true" 
                                                   requiredMessage="No Persona es obligatorio"
                                                   style="width:100%"/>
                                </td>
                                <td class="msg">
                                    <p:message for="noPersona"/>
                                </td>
                            </tr>

                            <!-- FILA 4: No Contrato -->
                            <tr>
                                <td class="lab">
                                    <p:outputLabel for="noCont" value="No Contrato *"/>
                                </td>
                                <td class="fld">
                                    <p:inputNumber id="noCont"
                                                   value="#{contratacionController.seleccionado.noCont}"
                                                   decimalPlaces="0" 
                                                   thousandSeparator=""

                                                   requiredMessage="No Contrato es obligatorio"
                                                   style="width:100%" disabled="true"/>
                                </td>
                                <td class="msg">
                                    <p:message for="noCont"/>
                                </td>
                            </tr>

                            <!-- FILA 5: Fecha Contrato -->
                            <tr>
                                <td class="lab">
                                    <p:outputLabel for="feContrato" value="Fecha Contrato *"/>
                                </td>
                                <td class="fld">
                                    <p:calendar id="feContrato"
                                                value="#{contratacionController.seleccionado.feContrato}"
                                                pattern="dd/MM/yyyy" 
                                                required="true" 
                                                requiredMessage="Fecha Contrato es obligatoria"
                                                style="width:100%"/>
                                </td>
                                <td class="msg">
                                    <p:message for="feContrato"/>
                                </td>
                            </tr>

                            <!-- FILA 6: Fecha Salida -->
                            <tr>
                                <td class="lab">
                                    <p:outputLabel for="feSalida" value="Fecha Salida"/>
                                </td>
                                <td class="fld">
                                    <p:calendar id="feSalida"
                                                value="#{contratacionController.seleccionado.feSalida}"
                                                pattern="dd/MM/yyyy" 

                                                style="width:100%"/>
                                </td>
                                <td class="msg">
                                    <p:message for="feSalida"/>
                                </td>
                            </tr>

                            <!-- FILA 7: No Documento -->
                            <tr>
                                <td class="lab">
                                    <p:outputLabel for="noDoc" value="No Documento"/>
                                </td>
                                <td class="fld">
                                    <p:inputText id="noDoc"
                                                 value="#{contratacionController.seleccionado.noDoc}"
                                                 maxlength="10"
                                                 style="width:100%"/>
                                </td>
                                <td class="msg">
                                    <p:message for="noDoc"/>
                                </td>
                            </tr>

                            <!-- FILA 8: Responsable -->
                            <tr>
                                <td class="lab">
                                    <p:outputLabel for="responsable" value="Responsable"/>
                                </td>
                                <td class="fld">
                                    <p:inputText id="responsable"
                                                 value="#{contratacionController.seleccionado.responsable}"
                                                 maxlength="50"
                                                 style="width:100%"/>
                                </td>
                                <td class="msg">
                                    <p:message for="responsable"/>
                                </td>
                            </tr>

                            <!-- FILA 9: Nivel -->
                            <tr>
                                <td class="lab">
                                    <p:outputLabel for="nivel" value="Nivel"/>
                                </td>
                                <td class="fld">
                                    <p:inputText id="nivel"
                                                 value="#{contratacionController.seleccionado.nivel}"
                                                 maxlength="2"
                                                 style="width:100%"/>
                                </td>
                                <td class="msg">
                                    <p:message for="nivel"/>
                                </td>
                            </tr>

                            <!-- FILA 10: Categoría -->
                            <tr>
                                <td class="lab">
                                    <p:outputLabel for="categoria" value="Categoría"/>
                                </td>
                                <td class="fld">
                                    <p:inputText id="categoria"
                                                 value="#{contratacionController.seleccionado.categoria}"
                                                 maxlength="2"
                                                 style="width:100%"/>
                                </td>
                                <td class="msg">
                                    <p:message for="categoria"/>
                                </td>
                            </tr>




                            <!-- FILA 12: Observaciones -->
                            <tr>
                                <td class="lab">
                                    <p:outputLabel for="obs" value="Observaciones"/>
                                </td>
                                <td class="fld">
                                    <p:inputTextarea id="obs"
                                                     value="#{contratacionController.seleccionado.obs}"
                                                     rows="3"
                                                     maxlength="250"
                                                     style="width:100%"/>
                                </td>
                                <td class="msg">
                                    <p:message for="obs"/>
                                </td>
                            </tr>

                        </tbody>
                    </table>

                </p:outputPanel>
            </h:panelGroup> 



            <f:facet name="footer">
                <p:commandButton value="Guardar"
                                 icon="pi pi-check"
                                 action="#{contratacionController.guardar}"
                                 process=":layoutForm:dlgForm"
                                 update=":layoutForm:dlg :layoutForm:tbl :layoutForm:msgsPage"
                                 oncomplete="if (args &amp;&amp; args.validationFailed) { PF('dlgCont').show(); } else { PF('dlgCont').hide(); }"/>

                <p:commandButton type="button"
                                 value="Cancelar"
                                 icon="pi pi-times"
                                 onclick="PF('dlgCont').hide()"
                                 styleClass="ui-button-secondary"/>

            </f:facet>
        </p:dialog>



        <!-- ============================================ -->
        <!-- DIÁLOGO crear nuevo (con su propio form)     -->
        <!-- ============================================ -->
        <p:dialog id="dlgCrear"
                  widgetVar="dlgCrear"
                  header="Sin contratos"
                  modal="true"
                  width="400">
            <h:form id="dlgCrearForm">
                <h:outputText value="No se encontraron contratos para: #{contratacionController.nombreEmpleado}"/>
                <br/><br/>
                <h:outputText value="¿Desea crear uno nuevo?"/>

                <f:facet name="footer">
                    <p:commandButton value="Sí, crear"
                                     icon="pi pi-check"
                                     actionListener="#{contratacionController.crearNuevoDesdeDialogo}"
                                     update=":layoutForm:dlg"
                                     styleClass="ui-button-success"
                                     oncomplete="PF('dlgCont').show(); PF('dlgCrear').hide();"/>
                    <p:commandButton value="No"
                                     icon="pi pi-times"
                                     onclick="PF('dlgCrear').hide(); return false;"
                                     styleClass="ui-button-secondary"/>
                </f:facet>
            </h:form>
        </p:dialog>

    </ui:define>
</ui:composition>
